<!DOCTYPE html>
<html>
<head>
  <title>GitHub Repository Size</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.3/css/mdui.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.3/js/mdui.min.js"></script>
  <script>
    function fetchRepositorySize() {
      var username = document.getElementById('username').value;
      var repository = document.getElementById('repository').value;

      // 构建API URL
      var apiUrl = 'https://api.github.com/repos/' + username + '/' + repository;

      // 发起GET请求获取数据
      $.get(apiUrl)
        .done(function(data) {
          var sizeInKB = data.size;
          var displaySize;

          if (sizeInKB >= 1024 * 1024) {
            var sizeInGB = (sizeInKB / (1024 * 1024)).toFixed(2);
            displaySize = sizeInGB + ' GB';
          } else if (sizeInKB >= 1024) {
            var sizeInMB = (sizeInKB / 1024).toFixed(2);
            displaySize = sizeInMB + ' MB';
          } else {
            displaySize = sizeInKB + ' KB';
          }

          // 显示仓库大小
          document.getElementById('result').textContent = '仓库大小：' + displaySize;

          // 显示按钮
          var buttonsContainer = document.getElementById('buttons');
          buttonsContainer.innerHTML = '<a href="https://github.com/' + username + '/' + repository + '" class="mdui-btn mdui-btn-raised mdui-ripple" target="_blank">跳转到仓库</a>' +
                                       '<a href="https://github.com/' + username + '" class="mdui-btn mdui-btn-raised mdui-ripple" target="_blank">打开作者 GitHub 主页</a>';
        })
        .fail(function(jqXHR) {
          var errorResponse = jqXHR.responseText.toLowerCase();

          if (jqXHR.status === 404) {
            document.getElementById('result').textContent = '仓库可能是私有的或不存在';
          } else if (errorResponse.includes('rate limit exceed')) {
            var errorMessage = 'IP被限制，请稍后重试';
            var rateLimitMessage = 'API rate limit exceeded for';
            var index = errorResponse.indexOf(rateLimitMessage);
            if (index !== -1) {
              var startIndex = index + rateLimitMessage.length;
              var endIndex = errorResponse.indexOf('.', startIndex);
              var ipAddress = errorResponse.substring(startIndex, endIndex).trim();
              errorMessage += '（IP：' + ipAddress + '）';
            }
            document.getElementById('result').textContent = errorMessage;
          } else {
            document.getElementById('result').textContent = '出错了：' + jqXHR.responseText;
          }

          // 清空按钮
          document.getElementById('buttons').innerHTML = '<a href="javascript:void(0);" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" disabled>跳转到仓库</a>' +
                                                           '<a href="javascript:void(0);" class="mdui-btn mdui-btn-raised mdui-ripple" disabled>打开作者 GitHub 主页</a>';
        });
    }

    function handleUsernameInput(event) {
      var usernameInput = document.getElementById('username');
      var repositoryInput = document.getElementById('repository');

      // 如果输入斜杠，则删除并切换到第二个文本框
      if (event.key === '/') {
        event.preventDefault();
        usernameInput.value = usernameInput.value.replace('/', '');
        repositoryInput.focus();
      }
    }

    function handlePaste(event) {
      event.preventDefault();
      var pastedData = event.clipboardData.getData('text/plain');
      var separatorIndex = pastedData.indexOf('/');

      if (separatorIndex !== -1) {
        var username = pastedData.substring(0, separatorIndex);
        var repository = pastedData.substring(separatorIndex + 1);

        document.getElementById('username').value = username;
        document.getElementById('repository').value = repository;
        document.getElementById('repository').focus();
      }
    }
  </script>
</head>
<body class="mdui-theme-primary-indigo mdui-theme-accent-pink">
  <header class="mdui-appbar mdui-color-theme">
    <div class="mdui-toolbar mdui-container">
      <a href="#" class="mdui-typo-headline">GitHub Repository Size</a>
    </div>
  </header>

  <div class="mdui-container">
    <div class="mdui-card mdui-m-y-3">
      <div class="mdui-card-content">
        <div class="mdui-textfield">
          <label class="mdui-textfield-label">用户名</label>
          <input type="text" id="username" class="mdui-textfield-input" placeholder="用户名" onkeydown="handleUsernameInput(event)" onpaste="handlePaste(event)">
        </div>
        <div class="mdui-textfield">
          <label class="mdui-textfield-label">仓库名</label>
          <input type="text" id="repository" class="mdui-textfield-input" placeholder="仓库名">
        </div>
        <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="fetchRepositorySize()">获取大小</button>
        <div id="buttons" class="mdui-m-t-1 mdui-m-b-2">
          <a href="javascript:void(0);" class="mdui-btn mdui-btn-raised mdui-ripple" disabled>跳转到仓库</a>
          <a href="javascript:void(0);" class="mdui-btn mdui-btn-raised mdui-ripple" disabled>打开作者 GitHub 主页</a>
        </div>
      </div>
    </div>

    <div id="result" class="mdui-typo"></div>
  </div>
</body>
</html>
